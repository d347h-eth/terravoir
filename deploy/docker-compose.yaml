services:
  postgres:
    image: postgres:13.2
    # Use Compose project "./.env" for interpolation in "command" (see "./.env.example")
    command: ["postgres","-c","max_connections=${PG_MAX_CONNECTIONS:-200}"]
    env_file:
      # Use "./postgres.env.example" to setup Postgres credentials
      - ./postgres.env
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:6.2.2
    command: ["redis-server","/usr/local/etc/redis/redis.conf"]
    volumes:
      # Use "./redis.conf.example" to setup Redis password
      - ./redis.conf:/usr/local/etc/redis/redis.conf:ro
      - redis_data:/data
    restart: unless-stopped

  rabbitmq:
    # Use Bitnami (legacy namespace) image with delayed exchange plugin available (set via env_file)
    image: bitnamilegacy/rabbitmq:3.12
    # Ensure we pull/run an image compatible with x86_64 hosts
    platform: linux/amd64
    env_file:
      # Use "./rabbitmq.env.example" to setup RabbitMQ credentials
      - ./rabbitmq.env
    volumes:
      - rabbitmq_data:/bitnami/rabbitmq/mnesia
    restart: unless-stopped

  indexer:
    build:
      context: ..
      dockerfile: packages/indexer/Dockerfile
    env_file:
      # Use "../packages/indexer/.env.example" to setup Indexer environment variables
      - ../packages/indexer/.env
    depends_on:
      - postgres
      - redis
      - rabbitmq
    restart: unless-stopped

  caddy:
    image: caddy:2-alpine
    container_name: caddy
    profiles: ["deployment"]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - indexer
    restart: unless-stopped

  promtail:
    image: grafana/promtail:2.9.3
    profiles: ["observability"]
    restart: unless-stopped
    command: ["--config.file=/etc/promtail/promtail-config.yml"]
    volumes:
      - ./promtail-config.yml:/etc/promtail/promtail-config.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro

volumes:
  postgres_data:
  redis_data:
  rabbitmq_data:
  caddy_data:
  caddy_config:
